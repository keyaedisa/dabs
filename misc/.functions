#!/bin/bash
# List of functions used by abs/d

source /etc/$BT/misc/.bashFormatting

trap_ctrlc() {
	echo
    echo "Ctrl-C detected. Ending current ${BT} session."
    exit
}

trap "trap_ctrlc" 2


cloneGit() {
	read -p "Would you like to clone the latest ${1} git to your home directory? ${fgRed}Warning${txReset}! This will replace this repo in your home directory if it already exists! (${fgGreen}Y${txReset}/${fgRed}N${txReset}): " YN
	finished="0"
	profileSelection=$1
	while [[ $finished != 1 ]]; do
	case $YN in
		y | Y | yes | Yes | YES )

			echo "Oki, cloning repo now."
			if [[ $profileSelection == "xero" ]]; then
				if [[ -d ~/xero_iso ]]; then
					rm -rf ~/xero_iso
					git clone https://github.com/xerolinux/xero_iso.git ~/xero_iso
				else
					git clone https://github.com/xerolinux/xero_iso.git ~/xero_iso
				fi
			elif [[ $profileSelection == "xerog" ]]; then
				if [[ -d ~/xero_g_iso ]]; then
					rm -rf ~/xero_g_iso
					git clone https://github.com/xerolinux/xero_g_iso.git ~/xero_g_iso
				else
					git clone https://github.com/xerolinux/xero_g_iso.git ~/xero_g_iso
				fi
			else
				echo "This never happens. Congrats"
			fi
			finished="1"
			echo "Done."
			;;
		n | N | no | No | NO )
			echo "Oki. ${BT} will not clone. Please run ${BT} in the directory containing the xero profile"
			finished="1"
			;;
		* )
			echo "${BT} does not understand your response. Please try again. ${fgGreen}Y${txReset} or ${fgRed}N${txReset}."
			read -p "Would you like to clone the latest ${1} git to your home directory?: " YN
			;;
	esac
	done
}

doesProfilePMCHaveValen () {
	pmanConf=$(cat $profile/airootfs/etc/pacman.conf)
	if [[ "$pmanConf" =~ "keyaedisa" ]]; then
		echo "Repo found in $profile/airootfs/etc/pacman.conf"
	else
		echo "Repo not found in $profile/airootfs/etc/pacman.conf! Will now add!"
		curl -fsSL https://raw.githubusercontent.com/keyaedisa/valen_repo/trunk/README.md | sed -n '11,14p' >> $profile/airootfs/etc/pacman.conf
		curl -fsSL https://raw.githubusercontent.com/keyaedisa/valen_repo/trunk/README.md | sed -n '11,14p' >> $profile/pacman.conf
	fi
	pmanConf=$(cat $profile/pacman.conf)
	if [[ "$pmanConf" =~ "keyaedisa" ]]; then
		echo "Repo found in $profile/pacman.conf"
	else
		echo "Repo not found in $profile/pacman.conf! Will now add!"
		curl -fsSL https://raw.githubusercontent.com/keyaedisa/valen_repo/trunk/README.md | sed -n '11,14p' >> $profile/pacman.conf
	fi
}

checkSudo() {
    if [[ ${UID} -eq 0 ]]; then
        echo "Must ${txBold}${fgRed}NOT${txReset} run ${BT} as root!"
        echo "Exiting now!"
#        sed '$d' /etc/${BT}/misc/lastErr && echo \$err6 > /etc/${BT}/misc/lastErr
        exit
    fi
}

checkInternetConnection() {
	ping -c 1 -q xerolinux.xyz >&/dev/null; if [[ $? != 0 ]]; then
	echo "${fgRed}Not connected to the internet${txReset}! Fix that and try again."
#	sed '$d' /etc/${BT}/misc/lastErr && echo \$err7 > /etc/${BT}/misc/lastErr
	exit
	fi
}

isArchisoUpToDate () {
	sudo pacman -Sy >> stfu.txt
	sudo pacman -S archiso --needed --noconfirm > /dev/null 2>stfu.txt
	if [[ -n $(sed -n 's/is up to date -- skipping//p' stfu.txt) ]]; then
		echo "Latest archiso check ${fgGreen}succesful${txReset}!" && sleep 1.7
		sudo rm stfu.txt
	else
		echo "Latest archiso check ${fgRed}failed${txReset}!"
		echo "Exiting now!"
		sudo rm stfu.txt
#		sed '$d' /etc/${BT}/misc/lastErr && echo \$err8 > /etc/${BT}/misc/lastErr
		exit
	fi
}

cloneGit() {
	read -p "Would you like to clone the latest ${1} git to your home directory? ${fgRed}Warning${txReset}! This will replace this repo in your home directory if it already exists! (${fgGreen}Y${txReset}/${fgRed}N${txReset}): " YN
	finished="0"
	profileSelection=$1
	while [[ $finished != 1 ]]; do
	case $YN in
		y | Y | yes | Yes | YES )

			echo "Oki, cloning repo now."
			if [[ $profileSelection == "xero" ]]; then
				if [[ -d ~/xero_iso ]]; then
					rm -rf ~/xero_iso
					git clone https://github.com/xerolinux/xero_iso.git ~/xero_iso
				else
					git clone https://github.com/xerolinux/xero_iso.git ~/xero_iso
				fi
			elif [[ $profileSelection == "xerog" ]]; then
				if [[ -d ~/xero_g_iso ]]; then
					rm -rf ~/xero_g_iso
					git clone https://github.com/xerolinux/xero_g_iso.git ~/xero_g_iso
				else
					git clone https://github.com/xerolinux/xero_g_iso.git ~/xero_g_iso
				fi
			else
				echo "This never happens. Congrats"
			fi
			finished="1"
			echo "Done."
			;;
		n | N | no | No | NO )
			echo "Oki. ${BT} will not clone. Please run ${BT} in the directory containing the xero profile"
			finished="1"
			;;
		* )
			echo "${BT} does not understand your response. Please try again. ${fgGreen}Y${txReset} or ${fgRed}N${txReset}."
			read -p "Would you like to clone the latest ${1} git to your home directory?: " YN
			;;
	esac
	done
}

